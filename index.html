<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Каталог напитков</title>
  <style>
    :root {
      --bg: #f7f7f8;
      --card: #ffffff;
      --text: #111111;
      --muted: #666666;
      --accent: #00a2ff;
      --border: #e6e6e6;
    }
    [data-theme="dark"] {
      --bg: #0f0f10;
      --card: #1a1b1e;
      --text: #f5f5f5;
      --muted: #b3b3b3;
      --accent: #62b4ff;
      --border: #2a2b2e;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .app { max-width: 820px; margin: 0 auto; padding: 16px; }
    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: saturate(1.2) blur(6px);
      background: color-mix(in oklab, var(--bg) 70%, transparent);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
    }
    h1 { font-size: 18px; margin: 0; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    .card img { width: 100%; aspect-ratio: 4 / 3; object-fit: cover; }
    .card .content { padding: 12px; }
    .card h3 { margin: 0 0 6px; font-size: 16px; }
    .card p { margin: 0; font-size: 13px; color: var(--muted); }
    .toolbar {
      display: flex; gap: 8px; padding: 8px 0; align-items: center; flex-wrap: wrap;
    }
    .btn {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn.back { display: inline-flex; align-items: center; gap: 6px; }
    .search {
      flex: 1;
      min-width: 160px;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 999px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    footer { color: var(--muted); font-size: 12px; padding: 24px 0; text-align: center; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="app" class="app">
    <header>
      <h1 id="title">Каталог напитков</h1>
    </header>

    <div class="toolbar">
      <button id="backBtn" class="btn back hidden" aria-label="Назад">← Назад</button>
      <input id="search" class="search" placeholder="Поиск по названию…" />
    </div>

    <main id="view"></main>
    <footer>Мини‑приложение для Telegram • Демо</footer>
  </div>

  <script>
    // Telegram WebApp API (injected by Telegram)
    const tg = window.Telegram?.WebApp;
    function applyTelegramTheme() {
      if (!tg) return;
      document.documentElement.setAttribute('data-theme', tg.colorScheme || 'light');
      // Apply theme params to CSS variables if available
      const tp = tg.themeParams || {};
      const map = {
        bg_color: '--bg',
        secondary_bg_color: '--card',
        text_color: '--text',
        hint_color: '--muted',
        link_color: '--accent'
      };
      Object.entries(map).forEach(([k, cssVar]) => {
        if (tp[k]) document.documentElement.style.setProperty(cssVar, tp[k]);
      });
      tg.ready();
      tg.expand();
    }
    applyTelegramTheme();

    // Simple router state
    let state = { category: null, query: "" };
    const title = document.getElementById('title');
    const backBtn = document.getElementById('backBtn');
    const search = document.getElementById('search');
    const view = document.getElementById('view');

    fetch('./data.json')
      .then(r => r.json())
      .then(data => init(data))
      .catch(() => {
        // Fallback example if data.json not found
        init({
          categories: [
            { id: "cocktails", name: "Коктейли", cover: "https://picsum.photos/seed/cocktails/640/480" },
            { id: "lemonades", name: "Лимонады", cover: "https://picsum.photos/seed/lemonade/640/480" },
            { id: "coffee", name: "Кофе", cover: "https://picsum.photos/seed/coffee/640/480" }
          ],
          items: [
            { id: "margarita", cat: "cocktails", name: "Маргарита", desc: "Текила, лайм, апельсиновый ликер", img: "https://picsum.photos/seed/margarita/800/600", price: "350 ₽" },
            { id: "mojito", cat: "cocktails", name: "Мохито", desc: "Ром, лайм, мята, сода", img: "https://picsum.photos/seed/mojito/800/600", price: "320 ₽" },
            { id: "berry-lemonade", cat: "lemonades", name: "Ягодный лимонад", desc: "Смородина, клубника, мята", img: "https://picsum.photos/seed/berry/800/600", price: "250 ₽" },
            { id: "citrus-lemonade", cat: "lemonades", name: "Цитрусовый лимонад", desc: "Апельсин, лимон, грейпфрут", img: "https://picsum.photos/seed/citrus/800/600", price: "250 ₽" },
            { id: "latte", cat: "coffee", name: "Латте", desc: "Эспрессо, молоко", img: "https://picsum.photos/seed/latte/800/600", price: "220 ₽" }
          ]
        });
      });

    function init(db) {
      // Persist direct start parameter if any (tgWebAppStartParam)
      const url = new URL(location.href);
      const startParam = url.searchParams.get('tgWebAppStartParam');
      if (startParam) console.log('start_param =', startParam);

      search.addEventListener('input', (e) => {
        state.query = e.target.value.toLowerCase().trim();
        render(db);
      });
      backBtn.addEventListener('click', () => {
        state.category = null;
        state.query = "";
        search.value = "";
        render(db);
      });

      render(db);
    }

    function render(db) {
      if (!state.category) {
        title.textContent = "Категории";
        backBtn.classList.add('hidden');
        const cards = db.categories.map(c => `
          <article class="card" role="button" tabindex="0" onclick="selectCategory('${c.id}')" onkeypress="if(event.key==='Enter')selectCategory('${c.id}')">
            <img src="${c.cover}" alt="${c.name}" />
            <div class="content">
              <h3>${c.name}</h3>
              <p>${countInCategory(db, c.id)} позиций</p>
            </div>
          </article>
        `).join('');
        view.innerHTML = `<section class="grid">${cards}</section>`;
      } else {
        const cat = db.categories.find(c => c.id === state.category);
        title.textContent = cat ? cat.name : "Каталог";
        backBtn.classList.remove('hidden');
        const items = db.items
          .filter(it => it.cat === state.category)
          .filter(it => it.name.toLowerCase().includes(state.query));
        const cards = items.map(it => `
          <article class="card">
            <img src="${it.img}" alt="${it.name}" />
            <div class="content">
              <h3>${it.name} • ${it.price || ""}</h3>
              <p>${it.desc || ""}</p>
            </div>
          </article>
        `).join('');
        view.innerHTML = `<section class="grid">${cards || "<p>Ничего не найдено.</p>"}</section>`;
      }
    }

    function countInCategory(db, id) {
      return db.items.filter(it => it.cat === id).length;
    }

    window.selectCategory = function(id) {
      state.category = id;
      render(window._db || {});
    }
  </script>
  <script>
    // Store db globally for selectCategory closure
    // This hack ensures _db is available after fetch resolves
    fetch('./data.json').then(r => r.json()).then(data => window._db = data).catch(()=>{});
  </script>
</body>
</html>
